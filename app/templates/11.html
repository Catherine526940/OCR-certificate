<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image OCR</title>
    <!-- 引入 Bootstrap 样式 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 自定义样式 */
        .image-container {
            margin-top: 20px;
        }
        .result-container {
            margin-top: 20px;
        }

        .button-column {
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* 按钮浮动到右侧 */
        }

        .button-column .delete-button {
            margin-left: 5px;
        }
        .button-column-row{
            display: flex;
            flex-direction: row;
            margin-bottom: 5px; /* 调整按钮之间的垂直间距 */
        }
        .button-column-row button{
            padding: 5px 10px; /* 调整按钮的内边距 */
            font-size: 14px; /* 调整按钮的字体大小 */
        }
        .column-title{
            height: 30px;
            font-size: 20px;
            line-height: 30px;
            margin: 10px 0;
        }
        .title-right{
            text-align: right;
            padding-right: 10px;
        }
        .title-left{
            text-align: center;
        }
        .preprocess-title{
            font-size: 15px;
            line-height: 20px;
            margin-right: 5px;
            width: 130px;
        }
        .preprocess-checkbox{
            width: 20px;
            height: 20px;
        }
        .preprocess-disabled{
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="pageTitle" class="text-center">Image OCR</h1>
        <div class="row">
            <div class="col-md-3">
                <form id="preprocessForm">
                    <div class="column-title title-left">额外预处理调节</div>
                    <div class="button-column-row">
                        <label class="preprocess-title" for="use-preprocess">是否额外预处理</label>
                        <input type="checkbox" class="preprocess-checkbox" id="use-preprocess">
                    </div>
                    <div class="button-column-row preprocess-disabled">
                        <label class="preprocess-title" for="use-binary">是否适应性二值化</label>
                        <input type="checkbox" class="preprocess-checkbox" id="use-binary" disabled>
                    </div>
                    <div class="button-column-row preprocess-disabled">
                        <label class="preprocess-title" for="use-filter">是否滤波</label>
                        <input type="checkbox" class="preprocess-checkbox" id="use-filter" disabled>
                    </div>
                    <div class="button-column-row preprocess-disabled">
                        <label class="preprocess-title" for="dilate-first">先膨胀后侵蚀</label>
                        <input type="checkbox" class="preprocess-checkbox" id="dilate-first" min="1" max="8" disabled>
                    </div>
                    <div class="button-column-row preprocess-disabled">
                        <label class="preprocess-title" for="erode-kernel">侵蚀核大小</label>
                        <div id="label-erode-kernel">1</div>
                        <input type="range" class="preprocess-range" id="erode-kernel" min="1" max="8" value="1"
                               disabled oninput="changeValue('erode-kernel')">
                    </div>
                    <div class="button-column-row preprocess-disabled">
                        <label class="preprocess-title" for="dilate-kernel">膨胀核大小</label>
                        <div id="label-dilate-kernel">1</div>
                        <input type="range" class="preprocess-range" id="dilate-kernel" min="1" max="8" value="1"
                               disabled oninput="changeValue('dilate-kernel')">
                    </div>
                </form>
            </div>
            <div class="col-md-6">
                <div class="row">
                    <div class="col-md-12">
                        <form id="imageForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <input type="file" class="form-control" id="imageInput" name="image" accept="image/*">
                            </div>
                            <div class="mb-3">
                                <button type="button" class="btn btn-primary" onclick="processImage()">识别</button>
                            </div>
                        </form>
                    </div>
                    <div class="col-md-12">
                        <div id="imageDisplay" class="image-container"></div>
                        <div id="resultDisplay" class="result-container"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="button-column">
                    <!-- 新建按钮 -->
                    <a href="/new" class="btn btn-secondary">新建识别模板</a>
                </div>
                <div class="column-title title-right">模板选择</div>
                <div id="documentButtons" class="button-column"></div>
            </div>
        </div>
    </div>

    <script>
        // 在文件选择后立即触发图片处理和展示
        document.getElementById('imageInput').onchange = function() {
            processImage();
        };
        document.getElementById('use-preprocess').onchange = (e)=>{
            if(e.target.checked){
                let nodes = document.getElementsByClassName("preprocess-disabled")
                while(nodes.length !== 0){
                    nodes[0].childNodes.forEach((item) => {
                        if(item.nodeName === "INPUT"){
                            item.disabled = false
                        }
                    })
                    nodes[0].className = "button-column-row preprocess-enabled"
                }
            }
            else{
                let nodes = document.getElementsByClassName("preprocess-enabled")
                while (nodes.length !== 0) {
                    nodes[0].childNodes.forEach((item) => {
                        if(item.nodeName === "INPUT"){
                            item.disabled = true
                        }
                    })
                    nodes[0].className = "button-column-row preprocess-disabled"
                }
            }
        }

        function processImage() {
            var input = document.getElementById('imageInput');
            var file = input.files[0];

            if (file) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    var imageData = e.target.result;

                    // 显示选择的图片
                    var imageDisplay = document.getElementById('imageDisplay');
                    imageDisplay.innerHTML = '<img src="' + imageData + '" class="img-fluid">';

                    // 发送图片数据到后端进行识别
                    fetch('/api/ocr', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ img: imageData })
                    })
                    .then(response => response.json())
                    .then(data => {
                        // 显示识别结果
                        var resultDisplay = document.getElementById('resultDisplay');
                        resultDisplay.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                    })
                    .catch(error => console.error('Error:', error));
                };
                reader.readAsDataURL(file);
            } else {
                alert('请选择图片文件.');
            }
        }
        function changeValue(e){
            document.getElementById(`label-${e}`).innerHTML = document.getElementById(e).value;
        }

        window.onload = function() {
            var addedButtons = JSON.parse(localStorage.getItem('addedButtons')) || [];

            // 创建并显示所有已添加的按钮
            var documentButtonsDiv = document.getElementById('documentButtons');
            addedButtons.forEach(function(buttonInfo) {
                var newButton = document.createElement('button');
                newButton.className = 'btn btn-secondary';
                newButton.textContent = buttonInfo.name;
                newButton.id = buttonInfo.id;
                newButton.onclick = function () {
                    fetch('/api/changemuban', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name: buttonInfo.name })
                    })
                    .then(response => response.json())
                    .then(data => {
                        // 更新页面标题
                        document.getElementById('pageTitle').textContent = buttonInfo.name;
                    })
                    .catch(error => console.error('Error:', error));

                }

                // 创建删除按钮
                var deleteButton = document.createElement('button');
                deleteButton.className = 'btn btn-danger delete-button';
                deleteButton.textContent = '删除';
                deleteButton.onclick = function() {
                    // 删除当前按钮
                    newButton.parentNode.removeChild(newButton);
                    deleteButton.parentNode.removeChild(deleteButton);
                    // 更新 localStorage 中的按钮信息
                    var updatedButtons = addedButtons.filter(function(btn) {
                        return btn.id !== buttonInfo.id;
                    });
                    localStorage.setItem('addedButtons', JSON.stringify(updatedButtons));
                    addedButtons = updatedButtons;
                };

                let newBtnRow = document.createElement("div");
                newBtnRow.className = "button-column-row";


                // 将新按钮和删除按钮添加到页面
                newBtnRow.appendChild(newButton);
                newBtnRow.appendChild(deleteButton);
                documentButtonsDiv.appendChild(newBtnRow)
            });
        }
    </script>

</body>
</html>
